@{
    ViewData["Title"] = "Send Message to Device";
}

<div class="container">
    <h1 class="mb-4">Send Message to Device</h1>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Device Communication</h5>
                </div>
                <div class="alert alert-info m-2">
                    <small>
                        <i class="bi bi-info-circle"></i> Messages sent from this form are sent directly to the device and are <strong>not stored</strong> in the database.
                        <br>
                        <strong>Your app is listening on port 5000</strong>
                    </small>
                </div>
                <div class="card-body">
                    <form id="deviceMessageForm">
                        <div class="mb-3">
                            <label for="ipAddress" class="form-label">Device IP Address</label>
                            <input type="text" class="form-control" id="ipAddress" name="ipAddress" value="@ViewBag.DefaultTargetIP" required>
                        </div>

                        <div class="mb-3">
                            <label for="port" class="form-label">Port</label>
                            <input type="number" class="form-control" id="port" name="port" value="@ViewBag.DefaultPort" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">IP Address Presets</label>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-ip="192.168.1.101" data-port="5000">LipoDoc (192.168.1.101:5000)</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary preset-btn" data-ip="127.0.0.3" data-port="5000">Hercules (127.0.0.3:5000)</button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="encoding" class="form-label">Message Encoding</label>
                            <select class="form-select" id="encoding" name="encoding">
                                <option value="ASCII" selected>ASCII</option>
                                <option value="UTF8">UTF-8</option>
                                <option value="Base64">Base64</option>
                                <option value="Hex">Hexadecimal</option>
                                <option value="Binary">Binary</option>
                            </select>
                            <div class="form-text">
                                Select the encoding method for sending the message
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="message" class="form-label">Message</label>
                            <textarea class="form-control" id="message" name="message" rows="4" placeholder="Enter your message here" required></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="sendButton">
                            <span class="spinner-border spinner-border-sm d-none" id="sendSpinner" role="status" aria-hidden="true"></span>
                            Send Message
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Communication Log</h5>
                </div>
                <div class="card-body">
                    <div id="logContainer" style="height: 300px; overflow-y: auto; font-family: monospace; background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <div class="text-muted">Communication log will appear here...</div>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-outline-secondary btn-sm" id="clearLog">Clear Log</button>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a asp-controller="DeviceData" asp-action="Index" class="btn btn-outline-primary">View Collected Data</a>
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary ms-2">Back to Home</a>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Encode message based on selected encoding
            function encodeMessage(message, encoding) {
                switch(encoding) {
                    case 'ASCII':
                        return new TextEncoder().encode(message);
                    case 'UTF8':
                        return new TextEncoder('utf-8').encode(message);
                    case 'Base64':
                        return Uint8Array.from(atob(message), c => c.charCodeAt(0));
                    case 'Hex':
                        // Remove spaces and non-hex characters
                        const hexClean = message.replace(/[^0-9A-Fa-f]/g, '');
                        return new Uint8Array(hexClean.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                    case 'Binary':
                        // Remove spaces and validate binary
                        const binaryClean = message.replace(/\s/g, '');
                        if (!/^[01]+$/.test(binaryClean)) {
                            throw new Error('Invalid binary string');
                        }
                        return new Uint8Array(binaryClean.match(/.{8}/g).map(byte => parseInt(byte, 2)));
                    default:
                        return new TextEncoder().encode(message);
                }
            }

            // Initialize form submission
            $('#deviceMessageForm').on('submit', function(e) {
                e.preventDefault();

                // Show spinner
                $('#sendButton').attr('disabled', true);
                $('#sendSpinner').removeClass('d-none');

                // Get form data
                const ipAddress = $('#ipAddress').val();
                const port = $('#port').val();
                const message = $('#message').val();
                const encoding = $('#encoding').val();

                try {
                    // Encode the message
                    const encodedMessage = encodeMessage(message, encoding);

                    // Log the attempt
                    logMessage('Sending', `Attempting to send ${encoding} encoded message to ${ipAddress}:${port}`);
                    logMessage('Message', `Raw message: ${message}`);
                    logMessage('Encoded', `Bytes: ${Array.from(encodedMessage).map(b => b.toString(16).padStart(2, '0')).join(' ')}`);

                    // Send request
                    $.ajax({
                        url: '@Url.Action("SendMessageToDevice", "Device")',
                        type: 'POST',
                        contentType: 'application/octet-stream',
                        data: JSON.stringify({
                            ipAddress: ipAddress,
                            port: port,
                            message: Array.from(encodedMessage),
                            encoding: encoding
                        }),
                        processData: false,
                        success: function(response) {
                            if (response.success) {
                                logMessage('Success', `Message sent successfully to ${ipAddress}:${port}`, 'success');

                                if (response.response) {
                                    logMessage('Response', response.response, 'info');
                                } else {
                                    logMessage('Info', 'No response received from device', 'info');
                                }
                            } else {
                                logMessage('Error', `Failed to send message to ${ipAddress}:${port}: ${response.response || 'Unknown error'}`, 'danger');
                            }
                        },
                        error: function(xhr, status, error) {
                            logMessage('Error', `Network Error: ${error}`, 'danger');
                            logMessage('Details', `Status: ${xhr.status}, Response: ${xhr.responseText}`, 'danger');
                        },
                        complete: function() {
                            // Hide spinner
                            $('#sendButton').attr('disabled', false);
                            $('#sendSpinner').addClass('d-none');
                        }
                    });
                } catch (encodeError) {
                    // Handle encoding errors
                    logMessage('Encoding Error', encodeError.message, 'danger');
                    $('#sendButton').attr('disabled', false);
                    $('#sendSpinner').addClass('d-none');
                }
            });

            // Clear log button
            $('#clearLog').on('click', function() {
                $('#logContainer').html('<div class="text-muted">Communication log will appear here...</div>');
            });

            // Preset buttons
            $('.preset-btn').on('click', function() {
                const ip = $(this).data('ip');
                const port = $(this).data('port');

                $('#ipAddress').val(ip);
                $('#port').val(port);

                logMessage('Info', `Preset selected: ${ip}:${port}`, 'info');
            });

            // Helper function to add log entries
            function logMessage(type, message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const colorClass = level === 'info' ? 'text-info' :
                                level === 'success' ? 'text-success' :
                                level === 'danger' ? 'text-danger' : 'text-muted';

                const logEntry = `<div class="mb-1">
                    <span class="text-muted">[${timestamp}]</span>
                    <span class="${colorClass}"><strong>${type}:</strong></span>
                    ${message}
                </div>`;

                // Only keep the placeholder if it's the only child
                if ($('#logContainer .text-muted').length === 1 && $('#logContainer').children().length === 1) {
                    $('#logContainer').html(logEntry);
                } else {
                    $('#logContainer').append(logEntry);
                }

                // Scroll to bottom
                const logContainer = document.getElementById('logContainer');
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        });
    </script>
}